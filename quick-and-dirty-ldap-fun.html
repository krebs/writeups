<!DOCTYPE html>
<html lang="en">
<head>

        <title>Quick and Dirty LDAP Fun</title>
        <meta charset="utf-8" />
        <link href="http://euer.krebsco.de/atom.xml" type="application/atom+xml" rel="alternate" title="only code is pure Full Atom Feed" />


        <!-- Mobile viewport optimized: j.mp/bplateviewport -->
        <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1">

        <link rel="stylesheet" type="text/css" href="./theme/gumby.css" />
        <link rel="stylesheet" type="text/css" href="./theme/style.css" />
        <link rel="stylesheet" type="text/css" href="./theme/pygment.css" />

        <script src="./theme/js/libs/modernizr-2.6.2.min.js"></script>






</head>

<body id="index" class="home">


    <div class="container">

        <div class="row">

          <header id="banner" class="body">
                  <h1><a href=".">only code is pure <strong></strong></a></h1>
          </header><!-- /#banner -->

            <div id="navigation" class="navbar row">
              <a href="#" gumby-trigger="#navigation &gt; ul" class="toggle"><i class="icon-menu"></i></a>
             
              <ul class="columns">
                <li><a href=".">Home</a></li>

                <li><a href="/wiki/knowledge_base.html">Wiki</a></li>
                <li><a href="/graphs/retiolum/">Graphs</a></li>
                <li><a href="/atom.xml">RSS</a></li>
                <li><a href="./pages/about.html">About</a></li>

              </ul>
            </div>

<section id="content" class="body">

   <div class="row">
        <div class="eleven columns">


            <header>
              <h2 class="entry-title">
                <a href="./quick-and-dirty-ldap-fun.html" rel="bookmark"
                   title="Permalink to Quick and Dirty LDAP Fun">Quick and Dirty LDAP Fun</a></h2>
           
            </header>
            <footer class="post-info">
              <abbr class="published" title="2014-02-24T22:44:00">
                Mon 24 February 2014
              </abbr>
              <address class="vcard author">
                By <a class="url fn" href="./author/makefu.html">makefu</a>
              </address>
            </footer><!-- /.post-info -->
            <div class="entry-content">
              <p>I was in the unfortunate situation that i needed to fix an ldap server,
specifically fixing a 'login failed' situation. There was only one problem, i
had fucking clue how ldap is configured, or even working. Also, i didn't
knew any passwords. But i had a user account on the system and google.</p>
<p>This article may be used as a quickstart for using (or hacking open) LDAP server installations.</p>
<div class="section" id="finding-what-you-need">
<h2>Finding what you need</h2>
<p>For working with the ldap you will need to find the configuration of the ldap
server. The Solaris server was running an old version (current_ldap is a lie of course)
of OpenLDAP bundled in the customized application.
The process list showed something like this: <cite>/opt/somewhere/current_ldap/libexec/sldap ldap:// ldaps:// ...</cite></p>
<p>As the ldap configuration most of the time resides somewhere in
<cite>&lt;ldap-installation&gt;/etc/openldap/sldap.conf</cite> this was my first lucky guess.</p>
<p>The configuration file was readable for every user on the server (duh!) and
contained the following <em>interesting</em> parameters:</p>
<div class="highlight"><pre><span class="nn">...</span>
<span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bdb</span>
<span class="l-Scalar-Plain">rootdn</span><span class="p-Indicator">:</span> <span class="s">&quot;cn=master,dc=company-name,dc=com&quot;</span>
<span class="l-Scalar-Plain">rootpw  {SSHA}cfCIXzBdyEzqcINQ0IT4gNFMupac1Yq2</span>
</pre></div>
</div>
<div class="section" id="cracking-ldap-passwords">
<h2>Cracking LDAP passwords</h2>
<p>As i needed full write-access to the ldap server, i threw the root password
into john-the-ripper:</p>
<p>The pass-file:</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">rootpw:{SSHA}cfCIXzBdyEzqcINQ0IT4gNFMupac1Yq2</span>
</pre></div>
<p>Running john:</p>
<div class="highlight"><pre><span class="c"># john pw</span>
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>Salted SHA-1 <span class="o">[</span>128/128 SSE2 intrinsics 4x<span class="o">])</span>
newuser          <span class="o">(</span>rootpw<span class="o">)</span>
guesses: 1  <span class="nb">time</span>: 0:00:00:00 DONE <span class="o">(</span>Mon Feb 24 23:10:02 2014<span class="o">)</span>  c/s: 66860
trying: ncc1701d - pat
Use the <span class="s2">&quot;--show&quot;</span> option to display all of the cracked passwords reliab
</pre></div>
<p>After a whopping , ummm, 0 seconds i recovered the root password. But this was
not really what was looking for, i wanted to make the GUI user log in again.
The server provides the tool <cite>ldaplist</cite> which lists all ldap entries.</p>
<p>The ldap client was somehow correctly configured in
<cite>/var/ldap/ldap_client_file</cite> and <cite>/var/ldap/ldap_client_cred</cite> so the root
password was not needed for that. Look somewhere else how to configure this
damn client :D.</p>
</div>
<div class="section" id="find-the-troublesome-account">
<h2>Find the troublesome account</h2>
<p><cite>ldaplist -v</cite> returned all entries for all ldap users. There are also lots of
examples of how to use the ldaplist to query specific informations. <em>I</em> knew i had to change
the password for the gui user but it seemed like the user was also blocked from
logging into the gui:</p>
<div class="highlight"><pre>user@ldapsrv<span class="nv">$ </span>ldaplist -v
  ...
  dn: <span class="nv">uid</span><span class="o">=</span>appadmin,ou<span class="o">=</span>appuser,dc<span class="o">=</span>company-name,dc<span class="o">=</span>com
    uid: appadmin
    cn: appadmin
    ...
    userPassword: <span class="o">{</span>crypt<span class="o">}</span>J6vlYXRU.sW8c
    isLocked: TRUE
</pre></div>
<p><cite>ldaplist -v</cite> returned the hashes for all users so we could try to crack them similar to the root password one but the appadmin was additionally locked even if we recover the password</p>
</div>
<div class="section" id="fix-the-raw-ldap-entries">
<h2>Fix the raw LDAP entries</h2>
<p>For modifying ldap entries there is <cite>ldapmodify</cite> which will either take commands via stdin or via file. For this tool we need the ldap root password an I used direct command entry like this:</p>
<div class="highlight"><pre>user@ldapsrv<span class="nv">$ </span>ldapmodify -D <span class="s2">&quot;&lt;rootdn&gt;&quot;</span> -w <span class="s2">&quot;&lt;rootpw&gt;&quot;</span>
  <span class="c"># input follows:</span>
  dn: <span class="nv">uid</span><span class="o">=</span>appadmin,ou<span class="o">=</span>appuser,dc<span class="o">=</span>company-name,dc<span class="o">=</span>com
  changetype: modify
  replace: userPassword
  userPassword: <span class="o">{</span>SSHA<span class="o">}</span>cfCIXzBdyEzqcINQ0IT4gNFMupac1Yq2
  Ctrl-d
  dn: <span class="nv">uid</span><span class="o">=</span>appadmin,ou<span class="o">=</span>appuser,dc<span class="o">=</span>company-name,dc<span class="o">=</span>com
  changetype: modify
  replace: isLocked
  isLocked: FALSE
  Ctrl-d
  Ctrl-d
</pre></div>
<p>At first i replace the userPassword with one we know (in this case the root user).
After that i set the isLocked Variable from <cite>TRUE</cite> to <cite>FALSE</cite>.
Now i could finally use the GUI and log in as the <cite>appadmin</cite> user with the password we just cracked.</p>
</div>
<div class="section" id="wrap-up">
<h2>Wrap-up</h2>
<p>OpenLDAP can be pretty handsome after a bit reading the fucking manual. It is also a great idea to leave config files unprotected in order to recover root passwords as an ordinary user.</p>
</div>

            </div><!-- /.entry-content -->
            <div class="comments">
              <h3>Comments</h3>
              <div id="disqus_thread"></div>
              <script type="text/javascript">
                var disqus_identifier = "quick-and-dirty-ldap-fun.html";
                (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://euer.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
              </script>
            </div>


        </div><!-- /.eleven.columns -->
        
<div class="three columns">

<h4>Pages</h4>

 <ul>
      <li><a href="/wiki/knowledge_base.html">Wiki</a></li>
      <li><a href="/graphs/retiolum/">Graphs</a></li>
      <li><a href="/atom.xml">RSS</a></li>
      <li><a href="./pages/about.html">About</a></li>
  </ul>

<h4>Categories</h4>
<ul>
		<li><a href="./category/posts.html">posts</a></li>
</ul>


<h4>Tags</h4>
	<ul>
	    <li class="tag-4"><a href="./tag/mdadm.html">mdadm</a></li>
	    <li class="tag-1"><a href="./tag/dropbear.html">dropbear</a></li>
	    <li class="tag-4"><a href="./tag/csr.html">csr</a></li>
	    <li class="tag-4"><a href="./tag/python.html">python</a></li>
	    <li class="tag-4"><a href="./tag/screen.html">screen</a></li>
	    <li class="tag-4"><a href="./tag/autosart.html">autosart</a></li>
	    <li class="tag-4"><a href="./tag/awstats.html">awstats</a></li>
	    <li class="tag-4"><a href="./tag/rhel.html">rhel</a></li>
	    <li class="tag-4"><a href="./tag/usb.html">usb</a></li>
	    <li class="tag-4"><a href="./tag/piwik.html">piwik</a></li>
	    <li class="tag-4"><a href="./tag/redhat.html">redhat</a></li>
	    <li class="tag-4"><a href="./tag/ldap.html">ldap</a></li>
	    <li class="tag-4"><a href="./tag/apache.html">apache</a></li>
	    <li class="tag-4"><a href="./tag/lighttpd.html">lighttpd</a></li>
	    <li class="tag-1"><a href="./tag/openssh.html">openssh</a></li>
	    <li class="tag-4"><a href="./tag/collectd.html">collectd</a></li>
	    <li class="tag-4"><a href="./tag/windows.html">windows</a></li>
	    <li class="tag-4"><a href="./tag/ftp.html">ftp</a></li>
	    <li class="tag-4"><a href="./tag/softraid.html">softraid</a></li>
	    <li class="tag-4"><a href="./tag/lvm.html">lvm</a></li>
	    <li class="tag-4"><a href="./tag/docker.html">docker</a></li>
	    <li class="tag-4"><a href="./tag/dvb-t.html">dvb-t</a></li>
	    <li class="tag-4"><a href="./tag/filesystems.html">filesystems</a></li>
	    <li class="tag-4"><a href="./tag/hackery.html">hackery</a></li>
	    <li class="tag-4"><a href="./tag/xattr.html">xattr</a></li>
	    <li class="tag-4"><a href="./tag/pelican.html">pelican</a></li>
	    <li class="tag-4"><a href="./tag/subjectaltname.html">subjectAltName</a></li>
	    <li class="tag-4"><a href="./tag/octopress.html">octopress</a></li>
	    <li class="tag-4"><a href="./tag/quickstart.html">quickstart</a></li>
	    <li class="tag-4"><a href="./tag/ruby.html">ruby</a></li>
	    <li class="tag-4"><a href="./tag/openssl.html">openssl</a></li>
	    <li class="tag-1"><a href="./tag/graphite.html">graphite</a></li>
	    <li class="tag-4"><a href="./tag/git.html">git</a></li>
	    <li class="tag-4"><a href="./tag/utf8.html">utf8</a></li>
	    <li class="tag-4"><a href="./tag/debian.html">debian</a></li>
	    <li class="tag-4"><a href="./tag/davfs.html">davfs</a></li>
	    <li class="tag-4"><a href="./tag/tmux.html">tmux</a></li>
	    <li class="tag-4"><a href="./tag/irssi.html">irssi</a></li>
	    <li class="tag-4"><a href="./tag/autostart.html">autostart</a></li>
	    <li class="tag-4"><a href="./tag/iso.html">iso</a></li>
	    <li class="tag-4"><a href="./tag/rtl2832u.html">rtl2832u</a></li>
</ul>


<nav class="widget">
  <h4>Social</h4>
  <ul>
    <li><a href="http://twitter.com/makefoo">@makefoo</a></li>
  </ul>
</nav>

</div> </div><!-- /.row -->


</section>

       </div><!-- /.row -->
    </div><!-- /.container -->


       <div class="container.nopad bg">

    
        <footer id="credits" class="row">
          <div class="seven columns left-center">

                   <address id="about" class="vcard body">
                    Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                    which takes great advantage of <a href="http://python.org">Python</a>.
                    <br />
                    Based on the <a target="_blank" href="http://gumbyframework.com">Gumby Framework</a>
                    </address>
          </div>


          <div class="seven columns">
            <div class="row">
              <ul class="socbtns">





              </ul>
            </div>
          </div>
        </footer>

    </div>


<script type="text/javascript">
    var disqus_shortname = 'euer';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
    <script type="text/javascript">
        var pkBaseURL = (("https:" == document.location.protocol) ? "https://mediengewitter.krebsco.de:10000/" : "http://mediengewitter.krebsco.de:10000/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript><p><img src="http://mediengewitter.krebsco.de:10000/piwik.php?idsite=1" style="border:0" alt="" /></p></noscript>
  <script src="./theme/js/libs/jquery-1.9.1.min.js"></script>
  <script src="./theme/js/libs/gumby.min.js"></script>
  <script src="./theme/js/plugins.js"></script>
</body>
</html>